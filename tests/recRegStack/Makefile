
SE?=/opt/SimpleElastix/
export PYTHONPATH=$(SE)/lib/python/


## run IM tools without setting cration and modification date (or -strip) to avoid changes in PNGs that are not visual: http://stackoverflow.com/questions/13577280/getting-imagemagick-convert-to-not-write-out-extra-info
## some bug now needs even more default options: http://unix.stackexchange.com/questions/255252/create-the-same-png-with-imagemagick-2-times-binaries-differ#255256
convertIM:= convert -define png:exclude-chunks=date,time +set date:create +set date:modify
mogrifyIM:= mogrify -define png:exclude-chunks=date,time +set date:create +set date:modify


SLICES= $(shell seq  -f %03.0f 1 9)
FNs:= $(SLICES:%=sMR3006g_OT1_s%.png)

.PHONY: test clean


test : reg reg2
test : reg/avg.png

clean:
	-rm -rv reg/
	-rm -rv reg2/

reg : parameterFile.txt
	python ../../recRegStack.py -i "*.png" -o $@ -p $< | tee $@.out

reg/avg.png : reg/
	$(convertIM) -average $</*.tif $@

reg/2016_12_02_0101_s02_06.tif : reg
reg2 : parameterFile.txt | reg/2016_12_02_0101_s02_06.tif reg/2016_12_02_0101_s02_06.txt
	mkdir -p reg2/
	ln -sf ../reg/2016_12_02_0101_s02_06.tif reg2/ # just for visual reference
	ln -sf ../reg/2016_12_02_0101_s02_06.txt reg2/ # only transform needed for master (using last transform file for InitialTransformParametersFileName)
	python ../../recRegStack.py -i "*.png" -o $@ -p $< \
		-S 2016_12_02_0101_s03_02.png 2016_12_02_0101_s03_03.png 2016_12_02_0101_s03_04.png | tee $@.out
